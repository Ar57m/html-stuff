<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Echo Chamber</title>
<style>
  :root {
    --bg: #f0f2f5; --panel: #ffffff; --text: #1c1e21; --muted: #65676b;
    --me-bg: #dcf8c6; --me-text: #000000;
    --other-bg: #ffffff; --other-text: #000000;
    --accent: #0084ff; --header-h: 60px;
  }
  [data-theme="dark"] {
    --bg: #0b141a; --panel: #111b21; --text: #e9edef; --muted: #8696a0;
    --accent: #00a884;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  html, body { 
    height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; 
    position: fixed; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg); color: var(--text);
  }

  /* Utility to prevent text selection on UI elements for better app-feel */
  .no-select { -webkit-user-select: none; user-select: none; }

  .app { display: flex; flex-direction: column; height: 100dvh; width: 100%; position: relative; }
  
  .topbar { 
    height: var(--header-h); background: var(--panel); display: flex; align-items: center; 
    padding: 0 15px; gap: 12px; border-bottom: 1px solid rgba(0,0,0,0.1); z-index: 10; flex-shrink: 0;
  }
  .topbar button { background: none; border: none; font-size: 20px; color: var(--text); cursor: pointer; }
  .title { flex: 1; text-align: center; font-weight: 600; line-height: 1.2; overflow: hidden; }
  .title small { display: block; font-size: 11px; color: var(--muted); font-weight: 400; }

  .main-container { display: flex; flex: 1; overflow: hidden; position: relative; }

  /* Floating Date Header */
  #floatingDate {
    position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
    background: rgba(30, 30, 30, 0.75); color: white; padding: 6px 14px;
    border-radius: 12px; font-size: 12px; z-index: 50; font-weight: 500;
    transition: opacity 0.3s ease; pointer-events: none; opacity: 0;
    -webkit-backdrop-filter: blur(4px);
    backdrop-filter: blur(4px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; display: none; }
  .sidebar-overlay.open { display: block; }
  
  .panel { 
    position: absolute; left: 0; top: 0; bottom: 0; width: 280px; 
    background: var(--panel); z-index: 100; transform: translateX(-100%); 
    transition: transform 0.3s ease; display: flex; flex-direction: column;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
  }
  .panel.open { transform: translateX(0); }
  .chat-list { flex: 1; overflow-y: auto; padding: 10px; }

  .chat-area { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; overflow: hidden; }
  .messages { 
      flex: 1; 
      overflow-y: auto; 
      padding: 15px; 
      display: flex; 
      flex-direction: column; 
      gap: 10px; 
      scroll-behavior: smooth;
  }

  .msg { 
    max-width: 85%; padding: 8px 12px; border-radius: 12px; position: relative; 
    font-size: 15px; line-height: 1.4; box-shadow: 0 1px 1px rgba(0,0,0,0.1);
    word-wrap: break-word; overflow-wrap: break-word; word-break: break-word;
    transition: transform 0.1s ease, filter 0.1s ease;
  }
  .msg.pressed { transform: scale(0.96); filter: brightness(0.9); }
  .msg.left { align-self: flex-start; background: var(--other-bg); color: var(--other-text); border-top-left-radius: 2px; }
  .msg.right { align-self: flex-end; background: var(--me-bg); color: var(--me-text); border-top-right-radius: 2px; }
  .msg .meta { font-size: 11px; opacity: 0.7; margin-bottom: 4px; font-weight: 600; display: flex; justify-content: space-between; gap: 10px; }
  .msg .time { font-weight: 400; font-size: 10px; }

  .composer { flex-shrink: 0; background: var(--panel); padding: 10px 12px; border-top: 1px solid rgba(0,0,0,0.05); padding-bottom: max(10px, env(safe-area-inset-bottom)); }
  .speaker-toggle { display: flex; gap: 5px; margin-bottom: 8px; }
  .speaker-toggle button {
    flex: 1; padding: 6px; border: 1px solid rgba(0,0,0,0.1); border-radius: 20px;
    background: transparent; font-size: 12px; font-weight: 500; color: var(--text);
  }
  .speaker-toggle #btnMe.active { background: var(--me-bg); color: var(--me-text); border-color: var(--me-bg); }
  .speaker-toggle #btnOther.active { background: var(--other-bg); color: var(--other-text); border-color: var(--other-bg); }

  .input-wrap { display: flex; gap: 8px; align-items: flex-end; }
  .text-input { 
    flex: 1; border: 1px solid rgba(0,0,0,0.05); background: var(--bg); border-radius: 18px; 
    padding: 10px 14px; resize: none; min-height: 40px; max-height: 160px; /* ~7 rows */
    color: var(--text); font-size: 16px; outline: none; overflow-y: auto;
  }
  .send-btn { width: 42px; height: 42px; border-radius: 50%; background: var(--accent); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }

  /* Modals */
  .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: grid; place-items: center; padding: 20px; }
  .modal { background: var(--panel); width: 100%; max-width: 400px; border-radius: 16px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; position: relative; }
  .hidden { display: none !important; }
  
  /* Form Elements */
  input[type="text"], input[type="password"], select, textarea { 
    width: 100%; padding: 10px; margin: 8px 0; border: 1px solid rgba(0,0,0,0.1); 
    border-radius: 8px; background: var(--bg); color: var(--text); font-family: inherit;
  }
  /* Edit modal textarea specific */
  #editText { resize: vertical; min-height: 120px; max-height: 50vh; }
  
  .btn-primary { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; }
  .btn-ghost { background: transparent; border: 1px solid rgba(0,0,0,0.1); color: var(--text); padding: 10px; border-radius: 10px; cursor: pointer; }
  .btn-danger { background: #ff4d4d; color: white; border: none; padding: 10px; border-radius: 10px; font-weight: 600; cursor: pointer; }
  
  .chat-item { padding: 12px; border-radius: 10px; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; }
  .chat-item.active { background: rgba(0,119,255,0.08); border-color: rgba(0,119,255,0.1); }
  
  /* Drag and Drop Visual */
  .chat-area.dragover::after {
    content: "Drop to Import Backup"; position: absolute; inset: 10px; border: 2px dashed var(--accent);
    background: rgba(0, 132, 255, 0.1); display: flex; align-items: center; justify-content: center;
    border-radius: 15px; font-weight: bold; pointer-events: none; z-index: 50; color: var(--accent);
  }
</style>
</head>
<body>

<div class="app" id="app">
  <div class="topbar">
    <button id="menuBtn">☰</button>
    <div class="title" id="title">Echo Chamber <small id="subtitle">Select a chat</small></div>
    <button id="settingsBtn">⚙</button>
  </div>

  <div class="main-container">
    <div id="floatingDate">Today</div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <aside class="panel" id="panel">
      <div style="padding:15px; border-bottom:1px solid rgba(0,0,0,0.05)">
        <h3 style="margin:0 0 10px 0">Chats</h3>
        <div style="display:flex; gap:8px">
          <button class="btn-primary" style="flex:2; padding:8px" id="newChatBtn">+ New</button>
          <button class="btn-ghost" style="flex:1; padding:8px; font-size:11px" id="importBtn">Import</button>
        </div>
      </div>
      <div class="chat-list" id="chatList"></div>
    </aside>

    <main class="chat-area" id="dropZone">
      <div class="messages" id="messages"></div>
      <div class="composer">
        <div class="speaker-toggle">
          <button id="btnOther" data-role="other">Companion</button>
          <button id="btnMe" data-role="me" class="active">You</button>
        </div>
        <div class="input-wrap">
          <textarea id="txtInput" class="text-input" placeholder="Type a message..." rows="1"></textarea>
          <button id="sendBtn" class="send-btn">➤</button>
        </div>
      </div>
    </main>
  </div>
</div>

<div id="passwordModal" class="modal-backdrop hidden">
  <div class="modal">
    <h3 id="pwTitle">Encryption</h3>
    <p id="pwDesc" style="font-size: 13px; color: var(--muted)"></p>
    <input type="password" id="pwInput" placeholder="Enter password (1-64 chars)" maxlength="64" />
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px">
      <button class="btn-primary" id="pwConfirm">Confirm</button>
      <button class="btn-ghost" id="pwCancel">Cancel</button>
    </div>
  </div>
</div>

<div id="settingsModal" class="modal-backdrop hidden">
  <div class="modal">
    <h3>Settings</h3>
    <div class="toggle-row" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px">
      <span>Enter to Send</span>
      <input type="checkbox" id="setEnterToSend" style="width: auto;">
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
      <div><label>Your Name</label><input type="text" id="setMyName" /></div>
      <div><label>Comp. Name</label><input type="text" id="setOtherName" /></div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px">
      <div><label>Your Color</label><input type="color" id="setMyColor" style="height:40px; padding:2px"/></div>
      <div><label>Comp. Color</label><input type="color" id="setOtherColor" style="height:40px; padding:2px"/></div>
    </div>
    <label>Theme</label>
    <select id="setTheme"><option value="light">Light</option><option value="dark">Dark</option></select>
    <div style="margin-top:20px; display:flex; flex-direction:column; gap:8px">
      <button class="btn-primary" id="saveSettings">Save Changes</button>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px">
        <button class="btn-ghost" id="exportAllBtn">Export Backup</button>
        <button class="btn-ghost" id="closeSettings">Close</button>
      </div>
    </div>
  </div>
</div>

<div id="editModal" class="modal-backdrop hidden">
  <div class="modal">
    <h3>Edit Message</h3>
    <textarea id="editText"></textarea>
    <div style="display:flex; flex-direction:column; gap:10px">
      <button class="btn-primary" id="editSave">Update Text</button>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
        <button class="btn-danger" id="editDelete">Delete Message</button>
        <button class="btn-ghost" id="editCancel">Cancel</button>
      </div>
    </div>
  </div>
</div>

<input id="fileInputHidden" type="file" accept=".json" class="hidden" />

<script>
(function(){
  const $ = id => document.getElementById(id);
  const LS_KEY = 'echo_chamber_v2_final';
  
  let state = {
    settings: { 
      myName: 'You', otherName: 'Companion', 
      myColor: '#dcf8c6', otherColor: '#ffffff', 
      theme: 'light', enterToSend: true 
    },
    chats: [], activeChatId: null
  };

  let currentRole = 'me';
  let editTarget = { chatId: null, msgId: null };
  let dateFadeTimer;

  // --- CRYPTO HELPERS (Web Crypto API) ---
  async function deriveKey(password, salt) {
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
    return crypto.subtle.deriveKey(
      { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
      keyMaterial,
      { name: "AES-GCM", length: 256 },
      false,
      ["encrypt", "decrypt"]
    );
  }

  async function encryptData(dataStr, password) {
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const key = await deriveKey(password, salt);
    const enc = new TextEncoder();
    const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, enc.encode(dataStr));
    
    return JSON.stringify({
      v: 1,
      salt: btoa(String.fromCharCode(...salt)),
      iv: btoa(String.fromCharCode(...iv)),
      data: btoa(String.fromCharCode(...new Uint8Array(encrypted)))
    });
  }

  async function decryptData(cipherJson, password) {
    try {
      const { salt, iv, data } = JSON.parse(cipherJson);
      const saltBuf = Uint8Array.from(atob(salt), c => c.charCodeAt(0));
      const ivBuf = Uint8Array.from(atob(iv), c => c.charCodeAt(0));
      const dataBuf = Uint8Array.from(atob(data), c => c.charCodeAt(0));
      
      const key = await deriveKey(password, saltBuf);
      const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv: ivBuf }, key, dataBuf);
      return new TextDecoder().decode(decrypted);
    } catch(e) {
      throw new Error("Wrong password or corrupted file.");
    }
  }

  // --- CORE LOGIC ---
  const uid = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 9);

  function load() {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) state = JSON.parse(raw);
    applySettings();
    renderChatList();
    renderMessages();
  }

  function save() {
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function applySettings() {
    document.body.setAttribute('data-theme', state.settings.theme);
    $('btnMe').textContent = state.settings.myName;
    $('btnOther').textContent = state.settings.otherName;
    document.documentElement.style.setProperty('--me-bg', state.settings.myColor);
    document.documentElement.style.setProperty('--other-bg', state.settings.otherColor);
    document.documentElement.style.setProperty('--me-text', getContrastColor(state.settings.myColor));
    document.documentElement.style.setProperty('--other-text', getContrastColor(state.settings.otherColor));
  }

  function getContrastColor(hex) {
    const r = parseInt(hex.substr(1, 2), 16), g = parseInt(hex.substr(3, 2), 16), b = parseInt(hex.substr(5, 2), 16);
    return ((r * 299) + (g * 587) + (b * 114)) / 1000 >= 128 ? '#111111' : '#ffffff';
  }

  // --- DATE & SCROLL HELPERS ---
  function getFriendlyDate(ts) {
    const d = new Date(ts);
    const today = new Date();
    const yesterday = new Date();
    yesterday.setDate(today.getDate() - 1);

    if (d.toDateString() === today.toDateString()) return 'Today';
    if (d.toDateString() === yesterday.toDateString()) return 'Yesterday';
    return d.toLocaleDateString('en-GB'); // dd/mm/yyyy
  }

  // Handle Scroll for Floating Date
  $('messages').onscroll = () => {
    const msgs = document.querySelectorAll('.msg');
    const fDate = $('floatingDate');
    const container = $('messages');
    let topMsg = null;

    // Find the first message that is visible in the container
    for (let m of msgs) {
      if (m.offsetTop + m.clientHeight > container.scrollTop + 20) {
        topMsg = m;
        break;
      }
    }

    if (topMsg) {
      const ts = parseInt(topMsg.dataset.ts);
      if(!ts) return;
      fDate.textContent = getFriendlyDate(ts);
      fDate.style.opacity = '1';
      clearTimeout(dateFadeTimer);
      dateFadeTimer = setTimeout(() => fDate.style.opacity = '0', 1500);
    }
  };

  // --- RENDER LOGIC ---
  function renderChatList() {
    const list = $('chatList'); list.innerHTML = '';
    state.chats.forEach(chat => {
      const item = document.createElement('div');
      item.className = `chat-item no-select ${chat.id === state.activeChatId ? 'active' : ''}`;
      item.innerHTML = `
        <div style="overflow:hidden; pointer-events:none;">
          <div style="font-weight:600; white-space:nowrap; text-overflow:ellipsis">${chat.title}</div>
          <small style="color:var(--muted)">${chat.messages.length} msgs</small>
        </div>
        <button onclick="event.stopPropagation(); window.delChat('${chat.id}')" style="background:none; border:none; color:#ff4d4d; font-size:18px">✕</button>
      `;
      
      // Interaction Handlers (Click + Long Press)
      let pressTimer;
      const start = (e) => { 
        pressTimer = setTimeout(() => {
          renameChat(chat.id);
        }, 600);
      };
      const end = (e) => clearTimeout(pressTimer);
      
      item.onmousedown = start;
      item.touchstart = start; // Basic touch support
      item.onmouseup = item.onmouseleave = end;
      // Touch listeners specific
      item.addEventListener('touchstart', start, {passive:true});
      item.addEventListener('touchend', end);
      item.addEventListener('contextmenu', e => { e.preventDefault(); }); // Prevent system menu

      item.onclick = () => { state.activeChatId = chat.id; save(); renderChatList(); renderMessages(); closeMenu(); };
      list.appendChild(item);
    });
  }

  window.renameChat = (id) => {
    const chat = state.chats.find(c => c.id === id);
    // Use prompt inside a timeout to ensure event loop clears
    setTimeout(() => {
        const newTitle = prompt('Rename Chat:', chat.title);
        if (newTitle && newTitle.trim()) { chat.title = newTitle.trim(); save(); renderChatList(); $('title').innerHTML = `${chat.title} <small>${chat.messages.length} messages</small>`; }
    }, 10);
  };

  function renderMessages() {
    const container = $('messages'); container.innerHTML = '';
    const chat = state.chats.find(c => c.id === state.activeChatId);
    if (!chat) { container.innerHTML = '<div style="text-align:center; margin-top:50px; color:var(--muted)">Drop a backup or create a chat</div>'; return; }
    
    $('title').innerHTML = `${chat.title} <small>${chat.messages.length} messages</small>`;
    
    chat.messages.forEach(msg => {
      const div = document.createElement('div');
      div.className = `msg no-select ${msg.role === 'me' ? 'right' : 'left'}`;
      div.dataset.ts = msg.ts; // Important for date scrolling
      div.innerHTML = `<div class="meta"><span>${msg.role === 'me' ? state.settings.myName : state.settings.otherName}</span><span class="time">${new Date(msg.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span></div><div class="text">${msg.text.replace(/\n/g, '<br>')}</div>`;
      
      // Long Press to Edit Logic
      let pressTimer;
      const start = (e) => { 
        div.classList.add('pressed');
        pressTimer = setTimeout(() => {
          div.classList.remove('pressed');
          openEdit(msg.id);
        }, 500); 
      };
      const clear = () => { clearTimeout(pressTimer); div.classList.remove('pressed'); };
      
      div.onmousedown = start;
      div.onmouseup = div.onmouseleave = clear;
      
      div.addEventListener('touchstart', start, {passive: true});
      div.addEventListener('touchend', clear);
      div.addEventListener('touchmove', clear); // Cancel if scrolling
      div.addEventListener('contextmenu', e => e.preventDefault()); // Stop right click menu

      container.appendChild(div);
    });
    container.scrollTop = container.scrollHeight;
  }

  // --- TEXTAREA AUTO-RESIZE ---
  const tx = $('txtInput');
  tx.addEventListener('input', function() {
    this.style.height = '40px';
    this.style.height = Math.min(this.scrollHeight, 160) + 'px';
  });

  // --- MODAL UTILS ---
  function toggleModal(id, show) { 
    $(id).classList.toggle('hidden', !show); 
    if(!show && id === 'passwordModal') $('pwInput').value = ''; 
  }

  // Click Outside to close
  window.onclick = (e) => {
    if (e.target.classList.contains('modal-backdrop')) {
      toggleModal(e.target.id, false);
    }
  };

  // --- PASSWORD PROMPT LOGIC ---
  let pwResolver = null;
  function promptPassword(title, desc) {
    toggleModal('passwordModal', true);
    $('pwTitle').innerText = title;
    $('pwDesc').innerText = desc;
    $('pwInput').focus();
    return new Promise(resolve => pwResolver = resolve);
  }
  $('pwConfirm').onclick = () => { let val = $('pwInput').value; toggleModal('passwordModal', false); pwResolver(val); };
  $('pwCancel').onclick = () => { toggleModal('passwordModal', false); pwResolver(null); };

  // --- EXPORT / IMPORT ---
  $('exportAllBtn').onclick = async () => {
    // 1. Close Settings first so Password modal is top
    toggleModal('settingsModal', false);

    // 2. Wait a tick then ask password
    setTimeout(async () => {
        const pw = await promptPassword("Encrypt Backup?", "Leave empty for no encryption. Password must be 1-64 chars.");
        let finalData = JSON.stringify(state);
        let fileName = `echo_backup_${Date.now()}.json`;

        if (pw && pw.length > 0) {
        finalData = await encryptData(finalData, pw);
        }

        const blob = new Blob([finalData], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = fileName; a.click();
    }, 100);
  };

  async function handleImport(file) {
    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        let content = e.target.result;
        let parsed = JSON.parse(content);

        // Check if it looks encrypted (has our custom keys)
        if (parsed.salt && parsed.iv && parsed.data) {
          const pw = await promptPassword("Encrypted File Detected", "Enter the password to decrypt this backup.");
          if (!pw) return;
          const decrypted = await decryptData(content, pw);
          parsed = JSON.parse(decrypted);
        }

        if (parsed.settings && parsed.chats) {
          state = parsed; save(); applySettings(); renderChatList(); renderMessages();
          alert("Backup Restored!");
        }
      } catch(err) { alert("Import failed: " + err.message); }
    };
    reader.readAsText(file);
  }

  // Drag and Drop
  const dz = $('dropZone');
  dz.ondragover = (e) => { e.preventDefault(); dz.classList.add('dragover'); };
  dz.ondragleave = () => dz.classList.remove('dragover');
  dz.ondrop = (e) => {
    e.preventDefault(); dz.classList.remove('dragover');
    if (e.dataTransfer.files.length) handleImport(e.dataTransfer.files[0]);
  };

  // --- UI EVENTS ---
  $('sendBtn').onclick = () => {
    const text = tx.value.trim();
    if (!text || !state.activeChatId) return;
    state.chats.find(c => c.id === state.activeChatId).messages.push({ id: uid(), role: currentRole, text, ts: Date.now() });
    tx.value = ''; tx.style.height = '40px'; 
    save(); 
    renderMessages(); 
    renderChatList(); // Update Sidebar count immediately
    $('messages').scrollTop = $('messages').scrollHeight;
  };

  tx.onkeydown = (e) => { if (state.settings.enterToSend && e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); $('sendBtn').click(); } };

  $('menuBtn').onclick = () => { $('panel').classList.add('open'); $('sidebarOverlay').classList.add('open'); };
  function closeMenu() { $('panel').classList.remove('open'); $('sidebarOverlay').classList.remove('open'); }
  $('sidebarOverlay').onclick = closeMenu;

  $('settingsBtn').onclick = () => {
    $('setMyName').value = state.settings.myName; $('setOtherName').value = state.settings.otherName;
    $('setMyColor').value = state.settings.myColor; $('setOtherColor').value = state.settings.otherColor;
    $('setTheme').value = state.settings.theme; $('setEnterToSend').checked = state.settings.enterToSend;
    toggleModal('settingsModal', true);
  };

  $('saveSettings').onclick = () => {
    state.settings = { ...state.settings, myName: $('setMyName').value, otherName: $('setOtherName').value, myColor: $('setMyColor').value, otherColor: $('setOtherColor').value, theme: $('setTheme').value, enterToSend: $('setEnterToSend').checked };
    save(); applySettings(); renderMessages(); toggleModal('settingsModal', false);
  };

  window.delChat = (id) => { if(confirm('Delete chat?')) { state.chats = state.chats.filter(c => c.id !== id); if(state.activeChatId === id) state.activeChatId = null; save(); renderChatList(); renderMessages(); } };
  
  function openEdit(id) {
    const chat = state.chats.find(c => c.id === state.activeChatId);
    const msg = chat.messages.find(m => m.id === id);
    editTarget = { chatId: chat.id, msgId: id };
    $('editText').value = msg.text;
    toggleModal('editModal', true);
  }

  $('editSave').onclick = () => {
    const msg = state.chats.find(c => c.id === editTarget.chatId).messages.find(m => m.id === editTarget.msgId);
    msg.text = $('editText').value; save(); renderMessages(); toggleModal('editModal', false);
  };

  $('editDelete').onclick = () => { if(confirm('Delete?')) {
    const chat = state.chats.find(c => c.id === editTarget.chatId);
    chat.messages = chat.messages.filter(m => m.id !== editTarget.msgId);
    save(); renderMessages(); renderChatList(); toggleModal('editModal', false);
  }};

  $('newChatBtn').onclick = () => {
    const title = prompt('Chat Name:');
    if (title) { const c = { id: uid(), title, messages: [] }; state.chats.unshift(c); state.activeChatId = c.id; save(); renderChatList(); renderMessages(); closeMenu(); }
  };

  // Init
  $('btnMe').onclick = () => { currentRole = 'me'; $('btnMe').classList.add('active'); $('btnOther').classList.remove('active'); };
  $('btnOther').onclick = () => { currentRole = 'other'; $('btnOther').classList.add('active'); $('btnMe').classList.remove('active'); };
  $('importBtn').onclick = () => $('fileInputHidden').click();
  $('fileInputHidden').onchange = (e) => handleImport(e.target.files[0]);
  $('closeSettings').onclick = () => toggleModal('settingsModal', false);
  $('editCancel').onclick = () => toggleModal('editModal', false);
  
  load();
})();
</script>
</body>
</html>
