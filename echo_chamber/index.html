<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Echo Chamber</title>
<style>
  :root {
    --bg: #f0f2f5; --panel: #ffffff; --text: #1c1e21; --muted: #65676b;
    --me-bg: #dcf8c6; --me-text: #000000;
    --other-bg: #ffffff; --other-text: #000000;
    --accent: #0084ff; --header-h: 60px;
  }
  [data-theme="dark"] {
    --bg: #0b141a; --panel: #111b21; --text: #e9edef; --muted: #8696a0;
    --accent: #00a884;
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  html, body { 
    height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; 
    position: fixed; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg); color: var(--text);
  }

  .no-select { -webkit-user-select: none; user-select: none; }

  .app { display: flex; flex-direction: column; height: 100dvh; width: 100%; position: relative; }
  
  .topbar { 
    height: var(--header-h); background: var(--panel); display: flex; align-items: center; 
    padding: 0 15px; gap: 12px; border-bottom: 1px solid rgba(0,0,0,0.1); z-index: 10; flex-shrink: 0;
  }
  .topbar button { background: none; border: none; font-size: 20px; color: var(--text); cursor: pointer; }
  .title { flex: 1; text-align: center; font-weight: 600; line-height: 1.2; overflow: hidden; }
  .title small { display: block; font-size: 11px; color: var(--muted); font-weight: 400; }

  .main-container { display: flex; flex: 1; overflow: hidden; position: relative; }

  #floatingDate {
    position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
    background: rgba(30, 30, 30, 0.75); color: white; padding: 6px 14px;
    border-radius: 12px; font-size: 12px; z-index: 50; font-weight: 500;
    transition: opacity 0.3s ease; pointer-events: none; opacity: 0;
    -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; display: none; }
  .sidebar-overlay.open { display: block; }
  
  .panel { 
    position: absolute; left: 0; top: 0; bottom: 0; width: 280px; 
    background: var(--panel); z-index: 100; transform: translateX(-100%); 
    transition: transform 0.3s ease; display: flex; flex-direction: column;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
  }
  .panel.open { transform: translateX(0); }
  .chat-list { flex: 1; overflow-y: auto; padding: 10px; }

  .chat-area { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; overflow: hidden; }
  .messages { 
      flex: 1; overflow-y: auto; padding: 15px; 
      display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth;
  }

  /* Date Separator Line */
  .day-separator {
    display: flex; align-items: center; justify-content: center; margin: 15px 0; opacity: 0.6;
  }
  .day-separator::before, .day-separator::after {
    content: ""; flex: 1; height: 1px; background: var(--muted); opacity: 0.3;
  }
  .day-separator span {
    padding: 0 10px; font-size: 11px; color: var(--muted); font-weight: 500;
  }

  .msg { 
    max-width: 85%; padding: 8px 12px; border-radius: 12px; position: relative; 
    font-size: 15px; line-height: 1.4; box-shadow: 0 1px 1px rgba(0,0,0,0.1);
    word-wrap: break-word; overflow-wrap: break-word; word-break: break-word;
    transition: transform 0.1s ease, filter 0.1s ease;
  }
  .msg.pressed { transform: scale(0.96); filter: brightness(0.9); }
  .msg.left { align-self: flex-start; border-top-left-radius: 2px; }
  .msg.right { align-self: flex-end; background: var(--me-bg); color: var(--me-text); border-top-right-radius: 2px; }
  
  .msg .meta { font-size: 11px; opacity: 0.7; margin-bottom: 4px; font-weight: 600; display: flex; justify-content: space-between; gap: 10px; }
  .msg .time { font-weight: 400; font-size: 10px; }

  .composer { flex-shrink: 0; background: var(--panel); padding: 10px 12px; border-top: 1px solid rgba(0,0,0,0.05); padding-bottom: max(10px, env(safe-area-inset-bottom)); }
  
  /* --- Speaker UI Modes --- */
  
  /* Mode 1: Multi-Voice (Scrollable) */
  .speaker-container.scroll-mode { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 8px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
  .speaker-container.scroll-mode::-webkit-scrollbar { display: none; }
  
  .speaker-container.scroll-mode .speaker-btn {
    flex: 0 0 auto; padding: 6px 14px; border: 1px solid rgba(0,0,0,0.1); border-radius: 20px;
    background: transparent; font-size: 12px; font-weight: 500; color: var(--text);
    cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 5px;
  }
  
  /* Mode 2: Symmetric (Standard) */
  .speaker-container.symmetric-mode { display: flex; gap: 8px; margin-bottom: 8px; }
  .speaker-container.symmetric-mode .speaker-btn {
    flex: 1; padding: 8px; border: 1px solid rgba(0,0,0,0.1); border-radius: 20px;
    background: transparent; font-size: 13px; font-weight: 500; color: var(--text);
    cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px;
  }

  /* Shared Active State */
  .speaker-btn.active { border-color: transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-weight: 600; }
  .speaker-btn.active .voice-dot { display: none; } /* Hide dot when active */

  .voice-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0;}

  .input-wrap { display: flex; gap: 8px; align-items: flex-end; }
  .text-input { 
    flex: 1; border: 1px solid rgba(0,0,0,0.05); background: var(--bg); border-radius: 18px; 
    padding: 10px 14px; resize: none; min-height: 40px; max-height: 160px;
    color: var(--text); font-size: 16px; outline: none; overflow-y: auto;
  }
  .send-btn { width: 42px; height: 42px; border-radius: 50%; background: var(--accent); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }

  /* Modals */
  .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: grid; place-items: center; padding: 20px; }
  .modal { background: var(--panel); width: 100%; max-width: 400px; border-radius: 16px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; position: relative; display: flex; flex-direction: column; }
  .hidden { display: none !important; }
  
  /* Form Elements */
  input[type="text"], input[type="password"], select, textarea { 
    width: 100%; padding: 10px; margin: 8px 0; border: 1px solid rgba(0,0,0,0.1); 
    border-radius: 8px; background: var(--bg); color: var(--text); font-family: inherit;
  }
  #editText, #voiceDetails { resize: vertical; min-height: 100px; max-height: 40vh; }
  
  .btn-primary { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; }
  .btn-ghost { background: transparent; border: 1px solid rgba(0,0,0,0.1); color: var(--text); padding: 10px; border-radius: 10px; cursor: pointer; width: 100%; text-align: center; }
  .btn-danger { background: #ff4d4d; color: white; border: none; padding: 10px; border-radius: 10px; font-weight: 600; cursor: pointer; width: 100%; }
  
  .chat-item { padding: 12px; border-radius: 10px; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; }
  .chat-item.active { background: rgba(0,119,255,0.08); border-color: rgba(0,119,255,0.1); }
  
  /* Voice List in Settings */
  .voice-list-item { 
    display: flex; align-items: center; justify-content: space-between; 
    padding: 10px; background: var(--bg); border-radius: 8px; margin-bottom: 8px; 
  }
  .voice-list-controls button { padding: 5px 8px; font-size: 14px; background: none; border: none; cursor: pointer; color: var(--text); opacity: 0.7; }

  .chat-area.dragover::after {
    content: "Drop to Import Backup"; position: absolute; inset: 10px; border: 2px dashed var(--accent);
    background: rgba(0, 132, 255, 0.1); display: flex; align-items: center; justify-content: center;
    border-radius: 15px; font-weight: bold; pointer-events: none; z-index: 50; color: var(--accent);
  }
</style>
</head>
<body>

<div class="app" id="app">
  <div class="topbar">
    <button id="menuBtn">☰</button>
    <div class="title" id="title">Echo Chamber <small id="subtitle">Select a chat</small></div>
    <button id="settingsBtn">⚙</button>
  </div>

  <div class="main-container">
    <div id="floatingDate">Today</div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <aside class="panel" id="panel">
      <div style="padding:15px; border-bottom:1px solid rgba(0,0,0,0.05)">
        <h3 style="margin:0 0 10px 0">Chats</h3>
        <div style="display:flex; gap:8px">
          <button class="btn-primary" style="flex:2; padding:8px" id="newChatBtn">+ New</button>
          <button class="btn-ghost" style="flex:1; padding:8px; font-size:11px" id="importBtn">Import</button>
        </div>
      </div>
      <div class="chat-list" id="chatList"></div>
    </aside>

    <main class="chat-area" id="dropZone">
      <div class="messages" id="messages"></div>
      <div class="composer">
        <div id="speakerContainer"></div>
        <div class="input-wrap">
          <textarea id="txtInput" class="text-input" placeholder="Type a message..." rows="1"></textarea>
          <button id="sendBtn" class="send-btn">➤</button>
        </div>
      </div>
    </main>
  </div>
</div>

<div id="passwordModal" class="modal-backdrop hidden">
  <div class="modal">
    <h3 id="pwTitle">Encryption</h3>
    <p id="pwDesc" style="font-size: 13px; color: var(--muted)"></p>
    <input type="password" id="pwInput" placeholder="Enter password (1-64 chars)" maxlength="64" />
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px">
      <button class="btn-primary" id="pwConfirm">Confirm</button>
      <button class="btn-ghost" id="pwCancel">Cancel</button>
    </div>
  </div>
</div>

<div id="settingsModal" class="modal-backdrop hidden">
  <div class="modal">
    <h3>Settings</h3>
    
    <div class="toggle-row" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px">
      <span>Enter to Send</span>
      <input type="checkbox" id="setEnterToSend" style="width: auto;">
    </div>
    <div class="toggle-row" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:15px">
      <span>Multi-Voice Mode</span>
      <input type="checkbox" id="setMultiVoice" style="width: auto;">
    </div>

    <div style="height:1px; background:rgba(0,0,0,0.1); margin: 10px 0;"></div>

    <label>Your Identity</label>
    <div style="display:grid; grid-template-columns: 3fr 1fr; gap:10px; margin-bottom:10px">
        <input type="text" id="setMyName" placeholder="Your Name" />
        <input type="color" id="setMyColor" style="height:40px; padding:2px"/>
    </div>

    <label>Voices</label>
    <button class="btn-ghost" id="manageVoicesBtn" style="margin-bottom:15px; text-align:left; display:flex; justify-content:space-between; align-items:center">
      <span>Manage Voices & Details</span>
      <span>›</span>
    </button>

    <label>Theme</label>
    <select id="setTheme"><option value="light">Light</option><option value="dark">Dark</option></select>
    
    <div style="margin-top:auto; padding-top:20px; display:flex; flex-direction:column; gap:8px">
      <button class="btn-primary" id="saveSettings">Save Changes</button>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px">
        <button class="btn-ghost" id="exportAllBtn">Export Backup</button>
        <button class="btn-ghost" id="closeSettings">Close</button>
      </div>
    </div>
  </div>
</div>

<div id="voiceManagerModal" class="modal-backdrop hidden">
  <div class="modal">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
      <h3 style="margin:0">Voices</h3>
      <button id="addVoiceBtn" style="background:var(--accent); color:white; border:none; border-radius:50%; width:30px; height:30px; font-weight:bold">+</button>
    </div>
    <div id="voiceListContainer" style="flex:1; overflow-y:auto; margin-bottom:15px"></div>
    <button class="btn-ghost" id="closeVoiceManager">Back to Settings</button>
  </div>
</div>

<div id="voiceEditModal" class="modal-backdrop hidden">
  <div class="modal">
    <h3 id="voiceEditTitle">Edit Voice</h3>
    
    <label>Name</label>
    <input type="text" id="voiceNameInput" placeholder="Name" />
    
    <label>Color</label>
    <input type="color" id="voiceColorInput" style="height:40px; padding:2px" />
    
    <label>Details / Notes</label>
    <textarea id="voiceDetails" placeholder="Character details, prompt instructions, or notes..."></textarea>

    <div style="margin-top:15px; display:flex; flex-direction:column; gap:8px">
      <button class="btn-primary" id="saveVoiceBtn">Save Voice</button>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px">
        <button class="btn-danger" id="deleteVoiceBtn">Delete</button>
        <button class="btn-ghost" id="cancelVoiceEdit">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div id="editModal" class="modal-backdrop hidden">
  <div class="modal">
    <h3>Edit Message</h3>
    <textarea id="editText"></textarea>
    <div style="display:flex; flex-direction:column; gap:10px">
      <button class="btn-primary" id="editSave">Update Text</button>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
        <button class="btn-danger" id="editDelete">Delete Message</button>
        <button class="btn-ghost" id="editCancel">Cancel</button>
      </div>
    </div>
  </div>
</div>

<input id="fileInputHidden" type="file" accept=".json" class="hidden" />

<script>
(function(){
  const $ = id => document.getElementById(id);
  const LS_KEY = 'echo_chamber_v2_final';
  
  let state = {
    settings: { 
      myName: 'You', 
      myColor: '#dcf8c6', 
      theme: 'light', 
      enterToSend: true,
      multiVoice: false,
      voices: [] 
    },
    chats: [], 
    activeChatId: null
  };

  let activeVoiceId = 'me';
  let editTarget = { chatId: null, msgId: null };
  let editingVoiceId = null;
  let dateFadeTimer;

  // --- CRYPTO HELPERS ---
  async function deriveKey(password, salt) {
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
    return crypto.subtle.deriveKey({ name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" }, keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]);
  }
  async function encryptData(dataStr, password) {
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const key = await deriveKey(password, salt);
    const enc = new TextEncoder();
    const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, enc.encode(dataStr));
    return JSON.stringify({ v: 1, salt: btoa(String.fromCharCode(...salt)), iv: btoa(String.fromCharCode(...iv)), data: btoa(String.fromCharCode(...new Uint8Array(encrypted))) });
  }
  async function decryptData(cipherJson, password) {
    try {
      const { salt, iv, data } = JSON.parse(cipherJson);
      const saltBuf = Uint8Array.from(atob(salt), c => c.charCodeAt(0));
      const ivBuf = Uint8Array.from(atob(iv), c => c.charCodeAt(0));
      const dataBuf = Uint8Array.from(atob(data), c => c.charCodeAt(0));
      const key = await deriveKey(password, saltBuf);
      const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv: ivBuf }, key, dataBuf);
      return new TextDecoder().decode(decrypted);
    } catch(e) { throw new Error("Wrong password or corrupted file."); }
  }

  // --- CORE LOGIC ---
  const uid = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 9);

  function load() {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) {
      state = JSON.parse(raw);
    } else {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      state.settings.theme = prefersDark ? 'dark' : 'light';
    }
    
    // MIGRATION
    if (!state.settings.voices) {
      state.settings.voices = [];
      if (state.settings.otherName) {
        state.settings.voices.push({ id: uid(), name: state.settings.otherName || 'Companion', color: state.settings.otherColor || '#ffffff', details: '' });
      }
    }
    if (state.settings.voices.length === 0) {
      state.settings.voices.push({ id: uid(), name: 'Companion', color: '#ffffff', details: '' });
    }

    applySettings();
    renderChatList();
    renderMessages();
    renderSpeakerList();
  }

  function save() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  function applySettings() {
    document.body.setAttribute('data-theme', state.settings.theme);
    document.documentElement.style.setProperty('--me-bg', state.settings.myColor);
    document.documentElement.style.setProperty('--me-text', getContrastColor(state.settings.myColor));
  }

  function getContrastColor(hex) {
    if(!hex) return '#000000';
    const r = parseInt(hex.substr(1, 2), 16), g = parseInt(hex.substr(3, 2), 16), b = parseInt(hex.substr(5, 2), 16);
    return ((r * 299) + (g * 587) + (b * 114)) / 1000 >= 128 ? '#111111' : '#ffffff';
  }

  function getVoice(id) {
    return state.settings.voices.find(v => v.id === id) || state.settings.voices[0];
  }

  // Name Validation
  function isNameTaken(name, currentId) {
    const n = name.trim().toLowerCase();
    if(n === state.settings.myName.trim().toLowerCase() && currentId !== 'me') return true;
    return state.settings.voices.some(v => v.name.trim().toLowerCase() === n && v.id !== currentId);
  }

  // --- DATE & SCROLL HELPERS ---
  function getFriendlyDate(ts) {
    const d = new Date(ts), today = new Date(), yesterday = new Date();
    yesterday.setDate(today.getDate() - 1);
    if (d.toDateString() === today.toDateString()) return 'Today';
    if (d.toDateString() === yesterday.toDateString()) return 'Yesterday';
    return d.toLocaleDateString('en-GB');
  }

  $('messages').onscroll = () => {
    const msgs = document.querySelectorAll('.msg');
    const fDate = $('floatingDate');
    const container = $('messages');
    let topMsg = null;
    for (let m of msgs) {
      if (m.offsetTop + m.clientHeight > container.scrollTop + 20) { topMsg = m; break; }
    }
    if (topMsg) {
      const ts = parseInt(topMsg.dataset.ts);
      if(!ts) return;
      fDate.textContent = getFriendlyDate(ts);
      fDate.style.opacity = '1';
      clearTimeout(dateFadeTimer);
      dateFadeTimer = setTimeout(() => fDate.style.opacity = '0', 1500);
    }
  };

  // --- RENDER LOGIC ---
  function renderChatList() {
    const list = $('chatList'); list.innerHTML = '';
    state.chats.forEach(chat => {
      const item = document.createElement('div');
      item.className = `chat-item no-select ${chat.id === state.activeChatId ? 'active' : ''}`;
      item.innerHTML = `
        <div style="overflow:hidden; pointer-events:none;">
          <div style="font-weight:600; white-space:nowrap; text-overflow:ellipsis">${chat.title}</div>
          <small style="color:var(--muted)">${chat.messages.length} msgs</small>
        </div>
        <button onclick="event.stopPropagation(); window.delChat('${chat.id}')" style="background:none; border:none; color:#ff4d4d; font-size:18px">✕</button>
      `;
      let pressTimer;
      const start = () => { pressTimer = setTimeout(() => window.renameChat(chat.id), 600); };
      const end = () => clearTimeout(pressTimer);
      item.onmousedown = start; item.onmouseup = item.onmouseleave = end;
      item.addEventListener('touchstart', start, {passive:true}); item.addEventListener('touchend', end);
      item.addEventListener('contextmenu', e => e.preventDefault());
      item.onclick = () => { state.activeChatId = chat.id; save(); renderChatList(); renderMessages(); closeMenu(); };
      list.appendChild(item);
    });
  }

  window.renameChat = (id) => {
    const chat = state.chats.find(c => c.id === id);
    setTimeout(() => {
        const newTitle = prompt('Rename Chat:', chat.title);
        if (newTitle && newTitle.trim()) { chat.title = newTitle.trim(); save(); renderChatList(); $('title').innerHTML = `${chat.title} <small>${chat.messages.length} messages</small>`; }
    }, 10);
  };

  function renderMessages() {
    const container = $('messages'); container.innerHTML = '';
    const chat = state.chats.find(c => c.id === state.activeChatId);
    if (!chat) { container.innerHTML = '<div style="text-align:center; margin-top:50px; color:var(--muted)">Drop a backup or create a chat</div>'; return; }
    
    $('title').innerHTML = `${chat.title} <small>${chat.messages.length} messages</small>`;
    
    let lastDateStr = '';

    chat.messages.forEach(msg => {
      // Date Separator Logic
      const msgDate = new Date(msg.ts);
      const msgDateStr = msgDate.toDateString();
      if (lastDateStr && lastDateStr !== msgDateStr) {
        const sep = document.createElement('div');
        sep.className = 'day-separator';
        sep.innerHTML = `<span>${getFriendlyDate(msg.ts)}</span>`;
        container.appendChild(sep);
      }
      lastDateStr = msgDateStr;

      const div = document.createElement('div');
      const isMe = msg.role === 'me';
      div.className = `msg no-select ${isMe ? 'right' : 'left'}`;
      div.dataset.ts = msg.ts;
      
      let name = state.settings.myName;
      let bubbleColor = '';
      let textColor = '';

      if (!isMe) {
        const voice = msg.voiceId ? getVoice(msg.voiceId) : state.settings.voices[0];
        name = voice ? voice.name : 'Unknown';
        if (voice) {
          bubbleColor = `background: ${voice.color};`;
          textColor = `color: ${getContrastColor(voice.color)};`;
        } else {
          bubbleColor = `background: var(--other-bg);`;
          textColor = `color: var(--other-text);`;
        }
      }
      
      div.style.cssText = !isMe ? `${bubbleColor} ${textColor}` : '';

      div.innerHTML = `<div class="meta"><span>${name}</span><span class="time">${new Date(msg.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span></div><div class="text">${msg.text.replace(/\n/g, '<br>')}</div>`;
      
      let pressTimer;
      const start = () => { div.classList.add('pressed'); pressTimer = setTimeout(() => { div.classList.remove('pressed'); openEdit(msg.id); }, 500); };
      const clear = () => { clearTimeout(pressTimer); div.classList.remove('pressed'); };
      div.onmousedown = start; div.onmouseup = div.onmouseleave = clear;
      div.addEventListener('touchstart', start, {passive: true}); div.addEventListener('touchend', clear); div.addEventListener('touchmove', clear);
      div.addEventListener('contextmenu', e => e.preventDefault());
      container.appendChild(div);
    });
    container.scrollTop = container.scrollHeight;
  }

  // --- COMPOSER & SPEAKER UI ---
  function renderSpeakerList() {
    const container = $('speakerContainer'); 
    container.innerHTML = '';
    
    // PC Scrolling Support for container
    container.onwheel = (e) => {
      if(container.classList.contains('scroll-mode')) {
        if(e.deltaY !== 0) { e.preventDefault(); container.scrollLeft += e.deltaY; }
      }
    };

    const createBtn = (id, name, color, isMe) => {
      const btn = document.createElement('button');
      const isActive = activeVoiceId === id;
      btn.className = `speaker-btn ${isActive ? 'active' : ''}`;
      
      if (isActive) {
        btn.style.background = isMe ? state.settings.myColor : color;
        btn.style.color = getContrastColor(isMe ? state.settings.myColor : color);
      } else if (!state.settings.multiVoice) {
         // In symmetric mode, show small dot or distinct border for inactive? 
         // Just show text, styling handled by CSS (transparent bg)
      }

      // Voice Dot (Hidden via CSS when active)
      const dot = `<span class="voice-dot" style="background:${color}"></span>`;
      btn.innerHTML = `${dot} ${name}`;
      
      btn.onclick = () => { activeVoiceId = id; renderSpeakerList(); };
      return btn;
    };

    if (state.settings.multiVoice) {
      container.className = 'speaker-container scroll-mode';
      // Me
      container.appendChild(createBtn('me', state.settings.myName, state.settings.myColor, true));
      // All Voices
      state.settings.voices.forEach(v => {
        container.appendChild(createBtn(v.id, v.name, v.color, false));
      });
    } else {
      // SYMMETRIC MODE (Classic)
      container.className = 'speaker-container symmetric-mode';
      const v = state.settings.voices[0];
      
      // Right Button (You) - Swapped order for visual balance if desired, but request implies symmetric
      // Usually "Companion" (Left) and "You" (Right) is standard chat logic
      
      // Companion Button
      if (v) container.appendChild(createBtn(v.id, v.name, v.color, false));
      
      // You Button
      container.appendChild(createBtn('me', state.settings.myName, state.settings.myColor, true));
    }
  }

  // --- SHORTCUTS & EVENTS ---
  document.addEventListener('keydown', (e) => {
    const active = document.activeElement;
    const tag = active ? active.tagName : null;
    const isTyping = tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';

    if (e.key === 'Backspace' && !isTyping) {
      e.preventDefault();

      if (!$('voiceEditModal')?.classList.contains('hidden')) {
        $('cancelVoiceEdit')?.click();
        return;
      }

      if (!$('voiceManagerModal')?.classList.contains('hidden')) {
        $('closeVoiceManager')?.click();
        return;
      }

      if (!$('settingsModal')?.classList.contains('hidden')) {
        $('closeSettings')?.click();
        return;
      }

      if (!$('editModal')?.classList.contains('hidden')) {
        $('editCancel')?.click();
        return;
      }
    }

    if (e.key === 'Enter' && !isTyping) {
      if (!$('voiceEditModal')?.classList.contains('hidden')) {
        $('saveVoiceBtn')?.click();
        return;
      }

      if (!$('settingsModal')?.classList.contains('hidden')) {
        $('saveSettings')?.click();
        return;
      }
    }
  });

  // --- TEXTAREA AUTO-RESIZE ---
  const tx = $('txtInput');
  tx.addEventListener('input', function() {
    this.style.height = '40px';
    this.style.height = Math.min(this.scrollHeight, 160) + 'px';
  });

  // --- MODAL UTILS ---
  function toggleModal(id, show) { 
    $(id).classList.toggle('hidden', !show); 
    if(!show && id === 'passwordModal') $('pwInput').value = ''; 
  }
  window.onclick = (e) => { if (e.target.classList.contains('modal-backdrop')) toggleModal(e.target.id, false); };

  // --- PASSWORD PROMPT ---
  let pwResolver = null;
  function promptPassword(title, desc) {
    toggleModal('passwordModal', true); $('pwTitle').innerText = title; $('pwDesc').innerText = desc; $('pwInput').focus();
    return new Promise(resolve => pwResolver = resolve);
  }
  $('pwConfirm').onclick = () => { let val = $('pwInput').value; toggleModal('passwordModal', false); pwResolver(val); };
  $('pwCancel').onclick = () => { toggleModal('passwordModal', false); pwResolver(null); };

  // --- EXPORT / IMPORT ---
  $('exportAllBtn').onclick = async (e) => {
    e.stopPropagation();

    toggleModal('settingsModal', false);

    const pw = await promptPassword(
      "Encrypt Backup?",
      "Leave empty for no encryption."
    );

    if (pw === null) return;

    let finalData = JSON.stringify(state);
    if (pw.length > 0) {
      finalData = await encryptData(finalData, pw);
    }

    const blob = new Blob([finalData], { type: "application/json" });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `echo_backup_${Date.now()}.json`;
    a.click();
  };

  $('pwInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      $('pwConfirm').click();
    }
  });


  async function handleImport(file) {
    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        let content = e.target.result;
        let parsed = JSON.parse(content);
        if (parsed.salt && parsed.iv && parsed.data) {
          const pw = await promptPassword("Encrypted File", "Enter password.");
          if (!pw) return;
          const decrypted = await decryptData(content, pw);
          parsed = JSON.parse(decrypted);
        }
        if (parsed.settings && parsed.chats) {
          state = parsed; 
          if(!state.settings.voices) {
             state.settings.voices = [{id:uid(), name: state.settings.otherName || 'Companion', color: state.settings.otherColor || '#ffffff', details:''}];
          }
          save(); applySettings(); renderChatList(); renderMessages(); renderSpeakerList();
          alert("Restored!");
        }
      } catch(err) { alert("Import failed."); }
    };
    reader.readAsText(file);
  }

  const dz = $('dropZone');
  dz.ondragover = (e) => { e.preventDefault(); dz.classList.add('dragover'); };
  dz.ondragleave = () => dz.classList.remove('dragover');
  dz.ondrop = (e) => { e.preventDefault(); dz.classList.remove('dragover'); if (e.dataTransfer.files.length) handleImport(e.dataTransfer.files[0]); };

  // --- SEND LOGIC ---
  $('sendBtn').onclick = () => {
    const text = tx.value.trim();
    if (!text) return;
    if (!state.activeChatId) {
      const newChat = { id: uid(), title: `New Chat ${state.chats.length + 1}`, messages: [] };
      state.chats.unshift(newChat); state.activeChatId = newChat.id;
    }
    const chat = state.chats.find(c => c.id === state.activeChatId);
    
    const role = activeVoiceId === 'me' ? 'me' : 'other';
    let effectiveVoiceId = activeVoiceId;
    if (role === 'other' && activeVoiceId === 'me') effectiveVoiceId = state.settings.voices[0].id; 
    if (role === 'other' && !state.settings.multiVoice) effectiveVoiceId = state.settings.voices[0].id;

    chat.messages.push({ id: uid(), role, voiceId: effectiveVoiceId, text, ts: Date.now() });
    
    tx.value = ''; tx.style.height = '40px';
    save(); renderMessages(); renderChatList(); $('messages').scrollTop = $('messages').scrollHeight;
  };

  tx.onkeydown = (e) => { if (state.settings.enterToSend && e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); $('sendBtn').click(); } };

  // --- UI ACTIONS ---
  $('menuBtn').onclick = () => { $('panel').classList.add('open'); $('sidebarOverlay').classList.add('open'); };
  function closeMenu() { $('panel').classList.remove('open'); $('sidebarOverlay').classList.remove('open'); }
  $('sidebarOverlay').onclick = closeMenu;

  $('newChatBtn').onclick = () => {
    const c = { id: uid(), title: `New Chat ${state.chats.length + 1}`, messages: [] };
    state.chats.unshift(c); state.activeChatId = c.id;
    save(); renderChatList(); renderMessages(); closeMenu();
  };

  $('importBtn').onclick = () => $('fileInputHidden').click();
  $('fileInputHidden').onchange = (e) => handleImport(e.target.files[0]);
  $('closeSettings').onclick = () => toggleModal('settingsModal', false);
  $('editCancel').onclick = () => toggleModal('editModal', false);

  // --- SETTINGS LOGIC ---
  $('settingsBtn').onclick = () => {
    $('setMyName').value = state.settings.myName; 
    $('setMyColor').value = state.settings.myColor;
    $('setTheme').value = state.settings.theme; 
    $('setEnterToSend').checked = state.settings.enterToSend;
    $('setMultiVoice').checked = state.settings.multiVoice;
    toggleModal('settingsModal', true);
  };

  $('saveSettings').onclick = () => {
    const newName = $('setMyName').value.trim();
    if(isNameTaken(newName, 'me')) { alert("Name already used by a voice."); return; }

    state.settings.myName = newName;
    state.settings.myColor = $('setMyColor').value;
    state.settings.theme = $('setTheme').value;
    state.settings.enterToSend = $('setEnterToSend').checked;
    
    const wasMulti = state.settings.multiVoice;
    state.settings.multiVoice = $('setMultiVoice').checked;
    
    if (wasMulti && !state.settings.multiVoice && activeVoiceId !== 'me') {
       activeVoiceId = state.settings.voices[0].id;
    }

    state.settings._userThemeLocked = true;
    save(); applySettings(); renderMessages(); renderSpeakerList();
    toggleModal('settingsModal', false);
  };

  $('manageVoicesBtn').onclick = () => {
    toggleModal('settingsModal', false);
    renderVoiceList();
    toggleModal('voiceManagerModal', true);
  };
  $('closeVoiceManager').onclick = () => {
    toggleModal('voiceManagerModal', false);
    toggleModal('settingsModal', true);
  };

  // --- VOICE MANAGER LOGIC ---
  function renderVoiceList() {
    const cont = $('voiceListContainer'); cont.innerHTML = '';
    state.settings.voices.forEach((v, idx) => {
      const row = document.createElement('div');
      row.className = 'voice-list-item';
      row.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px; flex:1">
          <div style="width:16px; height:16px; border-radius:50%; background:${v.color}; border:1px solid rgba(0,0,0,0.1)"></div>
          <span style="font-weight:500">${v.name}</span>
        </div>
        <div class="voice-list-controls">
          ${idx > 0 ? `<button onclick="window.moveVoice(${idx}, -1)">▲</button>` : ''}
          ${idx < state.settings.voices.length - 1 ? `<button onclick="window.moveVoice(${idx}, 1)">▼</button>` : ''}
          <button onclick="window.editVoice('${v.id}')">✎</button>
        </div>
      `;
      cont.appendChild(row);
    });
  }

  window.moveVoice = (idx, dir) => {
    const arr = state.settings.voices;
    [arr[idx], arr[idx + dir]] = [arr[idx + dir], arr[idx]];
    save(); renderVoiceList(); renderSpeakerList();
  };

  $('addVoiceBtn').onclick = () => {
    editingVoiceId = null; 
    $('voiceEditTitle').innerText = 'Add Voice';
    $('voiceNameInput').value = '';
    $('voiceColorInput').value = '#ffffff';
    $('voiceDetails').value = '';
    $('deleteVoiceBtn').classList.add('hidden');
    toggleModal('voiceManagerModal', false);
    toggleModal('voiceEditModal', true);
  };

  window.editVoice = (id) => {
    const v = state.settings.voices.find(x => x.id === id);
    editingVoiceId = id;
    $('voiceEditTitle').innerText = 'Edit Voice';
    $('voiceNameInput').value = v.name;
    $('voiceColorInput').value = v.color;
    $('voiceDetails').value = v.details || '';
    if (state.settings.voices.length > 1) $('deleteVoiceBtn').classList.remove('hidden');
    else $('deleteVoiceBtn').classList.add('hidden');
    toggleModal('voiceManagerModal', false);
    toggleModal('voiceEditModal', true);
  };

  $('saveVoiceBtn').onclick = () => {
    const name = $('voiceNameInput').value.trim() || 'Voice';
    if (isNameTaken(name, editingVoiceId)) { alert("Name already in use."); return; }

    const color = $('voiceColorInput').value;
    const details = $('voiceDetails').value;

    if (editingVoiceId) {
      const v = state.settings.voices.find(x => x.id === editingVoiceId);
      v.name = name; v.color = color; v.details = details;
    } else {
      state.settings.voices.push({ id: uid(), name, color, details });
    }
    save(); renderSpeakerList(); renderMessages();
    toggleModal('voiceEditModal', false);
    renderVoiceList();
    toggleModal('voiceManagerModal', true);
  };

  $('deleteVoiceBtn').onclick = () => {
    if (confirm('Delete this voice? Messages from them will remain but may lose color info.')) {
      state.settings.voices = state.settings.voices.filter(v => v.id !== editingVoiceId);
      if (activeVoiceId === editingVoiceId) activeVoiceId = 'me'; 
      save(); renderSpeakerList(); renderMessages();
      toggleModal('voiceEditModal', false);
      renderVoiceList();
      toggleModal('voiceManagerModal', true);
    }
  };

  $('cancelVoiceEdit').onclick = () => {
    toggleModal('voiceEditModal', false);
    toggleModal('voiceManagerModal', true);
  };

  // --- EDIT MESSAGE LOGIC ---
  function openEdit(id) {
    const chat = state.chats.find(c => c.id === state.activeChatId);
    const msg = chat.messages.find(m => m.id === id);
    editTarget = { chatId: chat.id, msgId: id };
    $('editText').value = msg.text;
    toggleModal('editModal', true);
  }

  $('editSave').onclick = () => {
    const msg = state.chats.find(c => c.id === editTarget.chatId).messages.find(m => m.id === editTarget.msgId);
    msg.text = $('editText').value; save(); renderMessages(); toggleModal('editModal', false);
  };

  $('editDelete').onclick = () => { if(confirm('Delete?')) {
    const chat = state.chats.find(c => c.id === editTarget.chatId);
    chat.messages = chat.messages.filter(m => m.id !== editTarget.msgId);
    save(); renderMessages(); renderChatList(); toggleModal('editModal', false);
  }};

  window.delChat = (id) => { if(confirm('Delete chat?')) { state.chats = state.chats.filter(c => c.id !== id); if(state.activeChatId === id) state.activeChatId = null; save(); renderChatList(); renderMessages(); } };

  // Init
  load();
  const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
  mediaQuery.addEventListener('change', e => { if (!state.settings._userThemeLocked) { state.settings.theme = e.matches ? 'dark' : 'light'; applySettings(); save(); } });

})();
</script>
</body>
</html>
